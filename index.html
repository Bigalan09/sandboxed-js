<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Script</title>
    <link rel="stylesheet" data-name="vs/editor/editor.main"
        href="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.20.0/min/vs/editor/editor.main.min.css">
</head>

<body>
    <div id="toolbar">
        <button id="save">Save</button>
    </div>
    <div id="container" style="height:400px;border:1px solid black;"></div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.26.1/min/vs/loader.min.js"></script>
    <script>
        // require is provided by loader.min.js.
        require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.26.1/min/vs' } });
        require(["vs/editor/editor.main"], () => {
            const editor = monaco.editor.create(document.getElementById('container'), {
                value: `async function main(context)
{
    return context.do();
}`,
                language: 'javascript',
                theme: 'vs-dark',
            });

            editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.KEY_S, function () {
                save(editor.getValue());
            });
            window.editor = editor;
        });

        const api = `
const api = {
    do: async() => { return 5},
}
`;
        const sandboxProxies = new WeakMap()

        function compileCode(src) {
            src = 'with (sandbox) {' + api + src + ' return main(api);}'
            const code = new Function('sandbox', src)

            return function (sandbox) {
                if (!sandboxProxies.has(sandbox)) {
                    const sandboxProxy = new Proxy(sandbox, { has, get })
                    sandboxProxies.set(sandbox, sandboxProxy)
                }
                return code(sandboxProxies.get(sandbox))
            }
        }

        function has(target, key) {
            return true
        }

        function get(target, key) {
            if (key === Symbol.unscopables) return undefined
            return target[key]
        }

        const savebtn = document.querySelector('#save');
        savebtn.addEventListener('click', () => save());

        function save(code) {
            if (!code) {
                code = window.editor.getValue()
            }
            runCode(code);
        }

        function runCode(code) {
            var compiledCode = compileCode(code);
            (async () => {
                var result = await compiledCode({});
                console.log(result);
            })();
        }
    </script>
</body>

</html>